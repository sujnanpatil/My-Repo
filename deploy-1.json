{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminUsername": {
      "type": "string"
    },
    "adminPassword": {
      "type": "securestring"
    },
    "AzureUserName": {
      "type": "string"
    },
    "AzurePassword": {
      "type": "securestring"
    },
    "ODLID": {
      "type": "string"
    },
    "DeploymentID": {
      "type": "string"
    },
    "trainerUserName": {
      "type": "string"
    },
    "trainerUserPassword": {
      "type": "string"
    },
    "emailId": {
      "type": "string",
      "defaultValue": " ",
      "metadata": "This will get the User Email ID who will be launching the lab from the parameter file using GET-USER-EMAIL-ID"
    }
  },
  "variables": {
    "scripturl": "https://experienceazure.blob.core.windows.net/templates/guided-labs/build-intelligent-apps-with-microsoft-copilot-stack-azure-openai/scripts/psscript-01.ps1",
    "userdata": "[concat('$url = \"', variables('scripturl'),'\"; $arg = \"', variables('arg'), '\"')]",
    "arg": "[concat(variables('arg1'),variables('arg2'),variables('arg3'),variables('arg4'),variables('arg5'))]",
    "arg1": "[concat(' -AzureUserName ', parameters('AzureUserName'), ' -AzurePassword ', parameters('AzurePassword'))]",
    "arg2": "[concat(' -AzureTenantID ', variables('AzureTenantID'), ' -AzureSubscriptionID ', variables('AzureSubscriptionID'))]",
    "arg3": "[concat(' -ODLID ', parameters('ODLID'), ' -DeploymentID ', parameters('DeploymentID'))]",
    "arg4": "[concat(' -vmAdminUsername ', parameters('adminUsername'), ' -vmAdminPassword ', parameters('adminPassword'))]",
    "arg5": "[concat(' -trainerUserName ', parameters('trainerUserName'), ' -trainerUserPassword ', parameters('trainerUserPassword'))]",
    "AzureSubscriptionID": "[subscription().subscriptionId]",
    "AzureTenantID": "[subscription().tenantId]",
    "addressPrefix": "10.0.0.0/16",
    "networkInterfaceName": "[concat(variables('vmName'), '-nic')]",
    "networkSecurityGroupName": "[concat(variables('vmName'), '-nsg')]",
    "publicIpAddressDNSName": "[concat('labvm', uniqueString(resourceGroup().id))]",
    "publicIpAddressName": "[concat(variables('vmName'), '-pip')]",
    "subnetName": "Subnet",
    "subnetPrefix": "10.0.0.0/24",
    "subnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/',variables('virtualNetworkName'), variables('subnetName'))]",
    "virtualNetworkName": "labvNet",
    "vmName": "[concat('labvm-',parameters('DeploymentID'))]",
    "location": "[resourceGroup().location]",
    "publisherName": "[concat('ODL-USER-',parameters('DeploymentID'))]",
    "accountName": "[concat('OpenAIService-',parameters('DeploymentID'))]",
    "CompletionModel": "[concat('miyagi-CompletionModel-',parameters('DeploymentID'))]",
    "EmbeddingModel": "[concat('miyagi-EmbeddingModel-',parameters('DeploymentID'))]",
    "servicename": "[concat('acs-',parameters('DeploymentID'))]",
    "cosmosAccountName": "[concat('cosmos-',parameters('DeploymentID'))]",
    "cosmosDatabaseName": "miyagi",
    "storageaccountname": "[concat('miyagiblobstorge',parameters('DeploymentID'))]",
    "acrName": "[concat('miyagiacr',parameters('DeploymentID'))]",
    "cosmosDatabaseName1": "recommendations",
    "bingsearchAPI": "ee5fb2bb99a6484289076c18c2163ca5",
    "vmdiskname": "[concat(variables('vmName'),'_OsDisk')]",
    "dhcpOption": {
      "dnsServers": [
        "48.216.235.241"
      ]
    },
    "dhcpOptions": "[if(contains(parameters('emailId'), 'tcs.com'), variables('dhcpOption'), json('null'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2017-04-01",
      "name": "[variables('virtualNetworkName')]",
      "location": "[variables('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('addressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('subnetName')]",
            "properties": {
              "addressPrefix": "[variables('subnetPrefix')]"
            }
          }
        ],
        "dhcpOptions": "[variables('dhcpOptions')]"
      }
    },
    {
      "type": "Microsoft.Network/publicIpAddresses",
      "apiVersion": "2017-08-01",
      "name": "[variables('publicIpAddressName')]",
      "location": "[variables('location')]",
      "properties": {
        "publicIpAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[concat(variables('publicIpAddressDNSName'))]"
        }
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2017-06-01",
      "name": "[variables('networkSecurityGroupName')]",
      "location": "[variables('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "default-allow-rdp",
            "properties": {
              "priority": 110,
              "protocol": "TCP",
              "access": "Allow",
              "direction": "Inbound",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "3389"
            }
          }
        ]
      }
    },
    {
      "name": "[variables('vmName')]",
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2022-11-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('networkInterfaceName'))]"
      ],
      "plan": {
        "name": "win2022mssd",
        "publisher": "spektra",
        "product": "cloudlabs-windows-jumpvm"
      },
      "properties": {
        "osProfile": {
          "computerName": "[variables('vmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]",
          "windowsConfiguration": {
            "provisionVmAgent": "true"
          }
        },
        "hardwareProfile": {
          "vmSize": "Standard_D4s_v3"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Spektra",
            "offer": "cloudlabs-windows-jumpvm",
            "sku": "win2022mssd",
            "version": "latest"
          },
          "osDisk": {
            "Name": "[concat(variables('virtualNetworkName'),'-osdisk')]",
            "createOption": "fromImage",
            "managedDisk": {
              "storageAccountType": "Standard_LRS"
            }
          },
          "dataDisks": []
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
            }
          ]
        },
        "userData": "[base64(variables('userdata'))]"
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2016-09-01",
      "name": "[variables('networkInterfaceName')]",
      "location": "[variables('location')]",
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
        "[concat('Microsoft.Network/publicIpAddresses/', variables('publicIpAddressName'))]",
        "[concat('Microsoft.Network/networkSecurityGroups/', variables('networkSecurityGroupName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[variables('subnetRef')]"
              },
              "privateIPAllocationMethod": "Dynamic",
              "publicIpAddress": {
                "id": "[resourceId(resourceGroup().name,'Microsoft.Network/publicIpAddresses', variables('publicIpAddressName'))]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
        }
      }
    },
    {
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2023-05-01",
      "name": "[variables('accountName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "S0"
      },
      "kind": "OpenAI",
      "properties": {
        "customSubDomainName": "[variables('accountName')]",
        "networkAcls": {
          "defaultAction": "Allow",
          "virtualNetworkRules": [],
          "ipRules": []
        },
        "publicNetworkAccess": "Enabled"
      }
    },
{
  "type": "Microsoft.CognitiveServices/accounts/deployments",
  "apiVersion": "2023-05-01",
  "name": "[concat(variables('accountName'),'/',variables('CompletionModel'))]",
  "dependsOn": [
    "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]"
  ],
  "sku": {
    "name": "Standard",
    "capacity": 8
  },
  "properties": {
    "model": {
      "format": "OpenAI",
      "name": "gpt-4.1",
      "version": "2025-04-14"
    },
    "versionUpgradeOption": "OnceNewDefaultVersionAvailable",
    "raiPolicyName": "Microsoft.Default"
  }
},
    {
      "type": "Microsoft.CognitiveServices/accounts/deployments",
      "apiVersion": "2023-05-01",
      "name": "[concat(variables('accountName'),'/',variables('EmbeddingModel'))]",
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]",
        "[resourceId('Microsoft.CognitiveServices/accounts/deployments',variables('accountName'), variables('CompletionModel'))]"
      ],
      "sku": {
        "name": "Standard",
        "capacity": 55
      },
      "properties": {
        "model": {
          "format": "OpenAI",
          "name": "text-embedding-ada-002",
          "version": "2"
        },
        "versionUpgradeOption": "OnceNewDefaultVersionAvailable",
        "raiPolicyName": "Microsoft.Default"
      }
    },
    {
      "type": "Microsoft.Search/searchServices",
      "apiVersion": "2021-04-01-Preview",
      "name": "[variables('servicename')]",
      "location": "[variables('location')]",
      "sku": {
        "name": "standard"
      },
      "properties": {
        "replicaCount": 1,
        "partitionCount": 1,
        "hostingMode": "Default"
      },
      "tags": {},
      "dependsOn": []
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "apiVersion": "2022-05-15",
      "name": "[variables('cosmosAccountName')]",
      "kind": "GlobalDocumentDB",
      "location": "[variables('Location')]",
      "properties": {
        "databaseAccountOfferType": "Standard",
        "consistencyPolicy": {
          "defaultConsistencyLevel": "Session"
        },
        "locations": [
          {
            "locationName": "[variables('Location')]"
          }
        ],
        "capacity": {
          "totalThroughputLimit": 11000
        }
      }
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
      "apiVersion": "2022-05-15",
      "name": "[format('{0}/{1}', toLower(variables('cosmosAccountName')), variables('cosmosDatabaseName'))]",
      "properties": {
        "resource": {
          "id": "[variables('cosmosDatabaseName')]"
        },
        "options": {
          "autoscaleSettings": {
            "maxThroughput": 2000
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(variables('cosmosAccountName')))]"
      ]
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
      "apiVersion": "2022-05-15",
      "name": "[format('{0}/{1}/{2}', toLower(variables('cosmosAccountName')), variables('cosmosDatabaseName'), variables('cosmosDatabaseName1'))]",
      "properties": {
        "resource": {
          "id": "[variables('cosmosDatabaseName1')]",
          "indexingPolicy": {
            "indexingMode": "consistent",
            "automatic": true,
            "includedPaths": [
              {
                "path": "/*"
              }
            ],
            "excludedPaths": [
              {
                "path": "/\"_etag\"/?"
              }
            ]
          },
          "partitionKey": {
            "paths": [
              "/partitionKey"
            ],
            "kind": "Hash"
          },
          "uniqueKeyPolicy": {
            "uniqueKeys": []
          },
          "conflictResolutionPolicy": {
            "mode": "LastWriterWins",
            "conflictResolutionPath": "/_ts"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', toLower(variables('cosmosAccountName')), variables('cosmosDatabaseName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[variables('storageaccountname')]",
      "location": "[variables('location')]",
      "sku": {
        "name": "Standard_LRS",
        "tier": "Standard"
      },
      "kind": "StorageV2",
      "properties": {
        "defaultToOAuthAuthentication": false,
        "minimumTlsVersion": "TLS1_0",
        "allowBlobPublicAccess": true,
        "allowSharedKeyAccess": true,
        "networkAcls": {
          "bypass": "AzureServices",
          "virtualNetworkRules": [],
          "ipRules": [],
          "defaultAction": "Allow"
        },
        "supportsHttpsTrafficOnly": true,
        "encryption": {
          "services": {
            "file": {
              "keyType": "Account",
              "enabled": true
            },
            "blob": {
              "keyType": "Account",
              "enabled": true
            }
          },
          "keySource": "Microsoft.Storage"
        },
        "accessTier": "Hot"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2023-01-01",
      "name": "[concat(variables('storageaccountname'), '/default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageaccountname'))]"
      ],
      "sku": {
        "name": "Standard_LRS",
        "tier": "Standard"
      },
      "properties": {
        "cors": {
          "corsRules": []
        },
        "deleteRetentionPolicy": {
          "allowPermanentDelete": false,
          "enabled": false
        }
      }
    },
    {
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2021-09-01",
      "name": "[variables('acrName')]",
      "location": "[variables('location')]",
      "tags": {
        "displayName": "Container Registry",
        "container.registry": "[variables('acrName')]"
      },
      "sku": {
        "name": "Basic",
        "tier": "Basic"
      },
      "properties": {
        "adminUserEnabled": true,
        "policies": {
          "quarantinePolicy": {
            "status": "disabled"
          },
          "trustPolicy": {
            "type": "Notary",
            "status": "disabled"
          },
          "retentionPolicy": {
            "days": 7,
            "status": "disabled"
          },
          "exportPolicy": {
            "status": "enabled"
          },
          "azureADAuthenticationAsArmPolicy": {
            "status": "enabled"
          },
          "softDeletePolicy": {
            "retentionDays": 7,
            "status": "disabled"
          }
        },
        "encryption": {
          "status": "disabled"
        },
        "dataEndpointEnabled": false,
        "publicNetworkAccess": "Enabled",
        "networkRuleBypassOptions": "AzureServices",
        "zoneRedundancy": "Disabled",
        "anonymousPullEnabled": false
      }
    }
  ],
  "outputs": {
    "Deployment ID": {
      "type": "string",
      "value": "[parameters('DeploymentID')]"
    },
    "LABVM Admin Username": {
      "type": "string",
      "value": "[parameters('adminUsername')]"
    },
    "LABVM Admin Password": {
      "type": "string",
      "value": "[parameters('adminPassword')]"
    },
    "LABVM DNS Name": {
      "type": "string",
      "value": "[concat(variables('publicIpAddressDNSName'), '.', resourceGroup().location, '.cloudapp.azure.com')]"
    },
    "Region": {
      "type": "string",
      "value": "[variables('location')]"
    },
    "OpenAIEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('accountName')), '2023-05-01').endpoint]"
    },
    "EmbeddingModel": {
      "type": "string",
      "value": "[variables('EmbeddingModel')]"
    },
    "CompletionModel": {
      "type": "string",
      "value": "[variables('CompletionModel')]"
    },
    "OpenAIKey": {
      "type": "string",
      "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', variables('accountName')), '2023-05-01').key1]"
    },
    "SearchServiceuri": {
      "type": "string",
      "value": "[concat('https://', variables('servicename') ,'.search.windows.net')]"
    },
    "CosmosDBuri": {
      "type": "string",
      "value": "[concat('https://', variables('cosmosAccountName') ,'.documents.azure.com:443')]"
    },
    "StorageAccounturi": {
      "type": "string",
      "value": "[concat('https://', variables('storageaccountname') ,'.blob.core.windows.net')]"
    },
    "SearchAPIkey": {
      "type": "string",
      "value": "[listAdminKeys(resourceId('Microsoft.Search/searchServices',variables('servicename')),'2021-04-01-Preview').primaryKey]"
    },
    "CosmosDBconnectinString": {
      "type": "string",
      "value": "[concat('AccountEndpoint=https://',variables('cosmosAccountName'),'.documents.azure.com:443/;AccountKey=',listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts',variables('cosmosAccountName')),'2022-05-15').primaryMasterKey,';')]"
    },
    "Bing_API_KEY": {
      "type": "string",
      "value": "[variables('bingsearchAPI')]"
    },
    "acrLoginServer": {
      "type": "String",
      "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries',variables('acrName')),'2023-08-01-preview').loginServer]"
    },
    "acrUsername": {
      "type": "String",
      "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries',variables('acrName')),'2023-08-01-preview').username]"
    },
    "acrPassword": {
      "type": "String",
      "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')),'2023-08-01-preview').passwords[0].value]"
    },
    "Trainer Password": {
      "type": "string",
      "value": "[parameters('trainerUserPassword')]"
    },
    "Trainer Username": {
      "type": "string",
      "value": "[parameters('trainerUserName')]"
    }
  }
}
